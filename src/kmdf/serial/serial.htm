<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="serial_files/filelist.xml">
<title>SERIAL</title>
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
    {font-family:Verdana;
    panose-1:2 11 6 4 3 5 4 4 2 4;
    mso-font-charset:0;
    mso-generic-font-family:swiss;
    mso-font-pitch:variable;
    mso-font-signature:536871559 0 0 0 415 0;}
@font-face
    {font-family:"MS Sans Serif";
    panose-1:0 0 0 0 0 0 0 0 0 0;
    mso-font-alt:"Times New Roman";
    mso-font-charset:0;
    mso-generic-font-family:roman;
    mso-font-format:other;
    mso-font-pitch:auto;
    mso-font-signature:0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
    {mso-style-parent:"";
    margin:0in;
    margin-bottom:.0001pt;
    mso-pagination:widow-orphan;
    font-size:12.0pt;
    font-family:"Times New Roman";
    mso-fareast-font-family:"Times New Roman";
    color:black;}
h2
    {mso-margin-top-alt:auto;
    margin-right:0in;
    mso-margin-bottom-alt:auto;
    margin-left:0in;
    mso-pagination:widow-orphan;
    mso-outline-level:2;
    font-size:18.0pt;
    font-family:"Times New Roman";
    color:black;
    font-weight:bold;}
h3
    {mso-margin-top-alt:auto;
    margin-right:0in;
    mso-margin-bottom-alt:auto;
    margin-left:0in;
    mso-pagination:widow-orphan;
    mso-outline-level:3;
    font-size:13.5pt;
    font-family:"Times New Roman";
    color:black;
    font-weight:bold;}
h4
    {mso-margin-top-alt:auto;
    margin-right:0in;
    mso-margin-bottom-alt:auto;
    margin-left:0in;
    mso-pagination:widow-orphan;
    mso-outline-level:4;
    font-size:12.0pt;
    font-family:"Times New Roman";
    color:black;
    font-weight:bold;}
a:link, span.MsoHyperlink
    {color:blue;
    text-decoration:underline;
    text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
    {color:purple;
    text-decoration:underline;
    text-underline:single;}
p
    {mso-margin-top-alt:auto;
    margin-right:0in;
    mso-margin-bottom-alt:auto;
    margin-left:0in;
    mso-pagination:widow-orphan;
    font-size:12.0pt;
    font-family:"Times New Roman";
    mso-fareast-font-family:"Times New Roman";
    color:black;}
pre
    {margin:0in;
    margin-bottom:.0001pt;
    mso-pagination:widow-orphan;
    tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
    font-size:10.0pt;
    font-family:"Courier New";
    mso-fareast-font-family:"Times New Roman";
    color:black;}
span.SpellE
    {mso-style-name:"";
    mso-spl-e:yes;}
span.GramE
    {mso-style-name:"";
    mso-gram-e:yes;}
@page Section1
    {size:8.5in 11.0in;
    margin:1.0in 1.25in 1.0in 1.25in;
    mso-header-margin:.5in;
    mso-footer-margin:.5in;
    mso-paper-source:0;}
div.Section1
    {page:Section1;}
 /* List Definitions */
 @list l0
    {mso-list-id:483359159;
    mso-list-type:hybrid;
    mso-list-template-ids:1295409758 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l0:level1
    {mso-level-tab-stop:39.75pt;
    mso-level-number-position:left;
    margin-left:39.75pt;
    text-indent:-.25in;}
@list l0:level2
    {mso-level-tab-stop:1.0in;
    mso-level-number-position:left;
    text-indent:-.25in;}
@list l0:level3
    {mso-level-tab-stop:1.5in;
    mso-level-number-position:left;
    text-indent:-.25in;}
@list l0:level4
    {mso-level-tab-stop:2.0in;
    mso-level-number-position:left;
    text-indent:-.25in;}
@list l0:level5
    {mso-level-tab-stop:2.5in;
    mso-level-number-position:left;
    text-indent:-.25in;}
@list l0:level6
    {mso-level-tab-stop:3.0in;
    mso-level-number-position:left;
    text-indent:-.25in;}
@list l0:level7
    {mso-level-tab-stop:3.5in;
    mso-level-number-position:left;
    text-indent:-.25in;}
@list l0:level8
    {mso-level-tab-stop:4.0in;
    mso-level-number-position:left;
    text-indent:-.25in;}
@list l0:level9
    {mso-level-tab-stop:4.5in;
    mso-level-number-position:left;
    text-indent:-.25in;}
ol
    {margin-bottom:0in;}
ul
    {margin-bottom:0in;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
    {mso-style-name:"Table Normal";
    mso-tstyle-rowband-size:0;
    mso-tstyle-colband-size:0;
    mso-style-noshow:yes;
    mso-style-parent:"";
    mso-padding-alt:0in 5.4pt 0in 5.4pt;
    mso-para-margin:0in;
    mso-para-margin-bottom:.0001pt;
    mso-pagination:widow-orphan;
    font-size:10.0pt;
    font-family:"Times New Roman";
    mso-ansi-language:#0400;
    mso-fareast-language:#0400;
    mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="3074"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body bgcolor=white lang=EN-US link=blue vlink=purple style='tab-interval:.5in'
leftmargin=8>

<div class=Section1>

<h2><span style='font-family:Verdana'>SERIAL <o:p></o:p></span></h2>

<h3><span style='font-family:Verdana'>SUMMARY<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>This serial (16550-based
RS-232) driver is a WDF version of inbox serial driver present under %DDKROOT%\<span
class=SpellE>src</span>\kernel\serial directory of the Windows DDK. This sample
is functionally equivalent to the WDM version of the sample with two
exceptions. 1) This sample doesn’t support Multi-function serial devices. 2) It
doesn’t support legacy serial ports – ports that are not detected by the BIOS
and as a result not enumerated by the OS.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The code works on
Microsoft® Windows® 2000 and later platforms. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The driver also supports
Power <span class=SpellE>Management<span class=GramE>; when</span></span> the
port is not opened, it is powered down and powered up on open. It supports
wake-on-ring for platforms that support that function. The driver works on both
x86 and 64 bit platforms. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>BUILDING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>To build the sample, run
the <b>build -<span class=SpellE>ceZ</span></b> command in the DDK build
environment.<span style='mso-spacerun:yes'>  </span>Once built, the sample
produces one binary: <span class=SpellE>Serial.sys</span>. The necessary <span
class=SpellE><span class=GramE>Inf</span></span> file is <span class=SpellE>msports.inf</span>
and is located in the %WINDIR%\<span class=SpellE>inf</span> directory.<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>INSTALLING THE SAMPLE<o:p></o:p></span></h3>

<h3><span style='font-size:10.0pt;font-family:Verdana;font-weight:normal;
mso-bidi-font-weight:bold'>For testing purposes, you can replace the inbox <span
class=SpellE>serial.sys</span> present in %windir%\system32\drivers with this
sample. Steps:<o:p></o:p></span></h3>

<h3 style='margin-left:39.75pt;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list 39.75pt'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal;mso-bidi-font-weight:bold'><span style='mso-list:Ignore'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-size:10.0pt;font-family:Verdana;font-weight:normal;mso-bidi-font-weight:
bold'>Disable <a
href="http://msdn.microsoft.com/library/en-us/wfp/setup/windows_file_protection_start_page.asp">Windows
File Protection</a> by following the information given below. <o:p></o:p></span></h3>

<h3 style='margin-left:39.75pt;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list 39.75pt'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal;mso-bidi-font-weight:bold'><span style='mso-list:Ignore'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-size:10.0pt;font-family:Verdana;font-weight:normal;mso-bidi-font-weight:
bold'>Bring up the Device Manager and disable all the com ports so that system
can unload the <span class=SpellE>serial.sys</span> driver. Make sure no
applications are talking to the serial device before you disable the ports.<o:p></o:p></span></h3>

<h3 style='margin-left:39.75pt;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list 39.75pt'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal;mso-bidi-font-weight:bold'><span style='mso-list:Ignore'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-size:10.0pt;font-family:Verdana;font-weight:normal;mso-bidi-font-weight:
bold'>Copy the sample <span class=SpellE>serial.sys</span> to windows <span
class=GramE>drivers</span> directory (%windir%\system32\drivers). If the
windows file protection is not disabled, the system will replace the sample
driver with the original inbox driver.<o:p></o:p></span></h3>

<h3 style='margin-left:39.75pt;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list 39.75pt'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal;mso-bidi-font-weight:bold'><span style='mso-list:Ignore'>4.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-size:10.0pt;font-family:Verdana;font-weight:normal;mso-bidi-font-weight:
bold'>Enable the ports to load the new driver. Make sure in the debugger that
your sample driver is loaded by <span class=GramE>running<span
style='mso-spacerun:yes'>  </span>“</span>!<span class=SpellE>lmi</span> <span
class=SpellE>serial.sys</span>”. This will dump information about the loaded
image.<o:p></o:p></span></h3>

<h3 style='margin-left:39.75pt;text-indent:-.25in;mso-list:l0 level1 lfo2;
tab-stops:list 39.75pt'><![if !supportLists]><span style='font-size:10.0pt;
font-family:Verdana;mso-fareast-font-family:Verdana;mso-bidi-font-family:Verdana;
font-weight:normal;mso-bidi-font-weight:bold'><span style='mso-list:Ignore'>5.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><![endif]><span
style='font-size:10.0pt;font-family:Verdana;font-weight:normal;mso-bidi-font-weight:
bold'>Run hypertrm.exe or some other test application to open port and
read/write.<o:p></o:p></span></h3>

<h2><span style='font-size:14.0pt;font-weight:normal;mso-bidi-font-weight:bold'><a
href="http://www.microsoft.com/whdc/winlogo/drvsign/wfp.mspx#EBAA">Disabling
Windows File Protection</a> <o:p></o:p></span></h2>

<p><span style='font-size:10.0pt;font-family:Verdana'>You may disable WFP by
setting the value <span class=SpellE><b>SFCDisable</b></span> (REG_DWORD) in <b>HKEY_LOCAL_MACHINE\
SOFTWARE\ Microsoft\ Windows NT\ <span class=SpellE>CurrentVersion</span>\ <span
class=SpellE>Winlogon</span></b>. By default, <span class=SpellE><b>SFCDisable</b></span>
is set to <b>0</b>, which means WFP is active. Setting <span class=SpellE><b>SFCDisable</b></span>
to <b>1</b> will disable WFP. Setting <span class=SpellE><b>SFCDisable</b></span>
to <b>2</b> will disable WFP for the next system restart only (without a prompt
to re-enable).<o:p></o:p></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>Important:</span></b><span
style='font-size:10.0pt;font-family:Verdana'> You must have a kernel debugger
attached to the system via null modem cable (for example<span class=GramE>:I386kd.exe</span>
or Windbg.exe) to use <span class=SpellE><b>SFCDisable</b></span><b> = 1</b> or
<span class=SpellE><b>SFCDisable</b></span><b> = 2</b>.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>After WFP is disabled
using the <span class=SpellE><b>SFCDisable</b></span><b> = 1</b> setting, the
following message will appear after logon:<o:p></o:p></span></p>

<p><i><span style='font-size:10.0pt;font-family:Verdana'>Warning! Windows File
Protection is not active on this system. Would you like to enable Windows File
Protection now? This will enable Windows File Protection until the next system
restart. &lt;Yes&gt; &lt;No&gt;.</span></i><span style='font-size:10.0pt;
font-family:Verdana'><o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>Clicking <span
class=GramE><b>Yes</b></span> will reactivate WFP until the next system
restart. This message will appear at every successful logon until <span
class=SpellE><b>SFCDisable</b></span> is set to <b>0</b>.<o:p></o:p></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>NOTE:</span></b><span
style='font-size:10.0pt;font-family:Verdana'> The above message will only be
presented to Administrators.<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>RESOURCES<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>For the serial
enumeration spec, read </span>http://www.microsoft.com/technet/prodtechnol/winntas/deploy/nt5serie.mspx#XS</p>

<h3><span style='font-family:Verdana'>CODE TOUR<o:p></o:p></span></h3>

<h4><span style='font-family:Verdana'>File Manifest<o:p></o:p></span></h4>

<pre><u>File<span style='mso-tab-count:3'>                   </span>Description<o:p></o:p></u></pre><pre><o:p>&nbsp;</o:p></pre><pre>Serial.htm<span
style='mso-tab-count:2'>             </span>The documentation for this sample (this file).</pre><pre><span
class=GramE>Sources<span style='mso-tab-count:3'>                </span>The generic file for building this code sample.</span></pre><pre><span
class=SpellE>Error.c</span><span style='mso-tab-count:3'>                </span>Error operations</pre><pre><span
class=SpellE>Immediate.c</span> <span style='mso-tab-count:2'>           </span>Handles the sending of immediate data</pre><pre><span
class=SpellE>Initunlo.c</span><span style='mso-tab-count:2'>             </span>Performs driver initialization and unload</pre><pre><span
class=SpellE>Ioctl.c</span><span style='mso-tab-count:3'>                </span>IOCTL requests</pre><pre><span
class=SpellE>Isr.c</span><span style='mso-tab-count:3'>                  </span>Interrupt service routine functionality</pre><pre><span
class=SpellE>Modmflow.c</span><span style='mso-tab-count:2'>             </span>Flow control functionality.</pre><pre><span
class=SpellE>Openclos.c</span><span style='mso-tab-count:2'>             </span><span
class=SpellE>CreateFile</span> / Close functionality</pre><pre><span
class=SpellE>Purge.c</span><span style='mso-tab-count:3'>                </span>Purge operations</pre><pre><span
class=SpellE>Read.c</span><span style='mso-tab-count:3'>                 </span>Read operations</pre><pre><span
class=SpellE>Serial.rc</span><span style='mso-tab-count:2'>              </span>Resource data</pre><pre><span
class=SpellE>Utils.c</span><span style='mso-tab-count:3'>                </span>Generic helper functionality</pre><pre><span
class=SpellE>Waitmask.c</span><span style='mso-tab-count:2'>             </span>Wait/Mask functionality</pre><pre><span
class=SpellE>Write.c</span><span style='mso-tab-count:3'>                </span>Write operations</pre><pre><span
class=SpellE>Pnp.c</span><span style='mso-tab-count:3'>                  </span>Plug-N-Play support</pre><pre><span
class=SpellE>Registry.c</span><span style='mso-tab-count:2'>             </span>Misc. registry access functions</pre><pre><span
class=SpellE>Wmi.c</span><span style='mso-tab-count:3'>                  </span>WMI support</pre><pre><span
class=SpellE>Power.c</span><span style='mso-tab-count:3'>                </span>Power support</pre><pre><span
class=SpellE>Serlog.mc</span><span style='mso-tab-count:2'>              </span>Log messages</pre><pre><o:p>&nbsp;</o:p></pre>

<p align=center style='text-align:center;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:10.0pt;font-family:"Courier New"'><a href="#top"><span
style='font-family:Verdana'>Top of page</span></a></span><span
style='font-size:10.0pt;font-family:Verdana;mso-bidi-font-family:"Courier New"'>
<o:p></o:p></span></p>

<pre><o:p>&nbsp;</o:p></pre>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=624
 style='width:6.5in;mso-cellspacing:0in;mso-padding-alt:0in 5.4pt 0in 5.4pt'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes;
  height:1.5pt'>
  <td style='background:aqua;padding:.75pt .75pt .75pt .75pt;height:1.5pt'>
  <p class=MsoNormal><o:p>&nbsp;</o:p></p>
  </td>
 </tr>
</table>

<pre><o:p>&nbsp;</o:p></pre><pre><o:p>&nbsp;</o:p></pre>

<p style='tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
style='font-size:7.5pt;font-family:"MS Sans Serif";mso-bidi-font-family:"Courier New"'>©
1999 Microsoft Corporation</span><span style='font-size:10.0pt;font-family:
Verdana;mso-bidi-font-family:"Courier New"'> <o:p></o:p></span></p>

</div>

</body>

</html>

